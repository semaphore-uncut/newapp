version: v1.0
name: Test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Tests
    task:
      prologue:
        commands:
          - checkout
      jobs:
      - name: RSpec - models
        matrix:
          - env_var: RATE
            values: ["10K", "100K", "1M"]
          - env_var: URL
            values:
              - "https://s3-us-west-1.amazonaws.com/hetzner-speedtest-us-west1/elasticsearch-6.2.1.deb"
              - "https://s3.eu-west-2.amazonaws.com/hetzner-speedtest-eu-west2/elasticsearch-6.2.1.deb"
              - "https://s3.amazonaws.com/hetzner-speedtest-us-east1/elasticsearch-6.2.1.deb"
        commands:
          - bundle exec rspec
          - echo "Rate: $RATE"
          - curl --limit-rate $RATE $URL > /dev/null
